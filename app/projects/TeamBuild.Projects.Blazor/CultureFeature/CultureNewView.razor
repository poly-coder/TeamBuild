@inherits TbCustomView

@{
    Render(__builder);
}

@code
{
    [Parameter]
    public Func<FormModel, Task>? OnSave { get; set; }

    [Parameter]
    public FormModel? InitialForm { get; set; }

    protected FormModel? Form { get; set; }
    private FormModel? previousInitialForm;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        if (Form is null || previousInitialForm is null || !previousInitialForm.IsEqualTo(InitialForm))
        {
            previousInitialForm = InitialForm?.Clone() ?? new FormModel();
            Form = InitialForm?.Clone() ?? new FormModel();
        }
    }

    public class FormModel
    {
        [Required] public string CultureCode { get; set; } = "";

        [Required] public string EnglishName { get; set; } = "";

        [Required] public string NativeName { get; set; } = "";

        public bool GoToDetails { get; set; }

        public FormModel Clone()
        {
            return new FormModel
            {
                CultureCode = CultureCode,
                EnglishName = EnglishName,
                NativeName = NativeName
            };
        }

        public bool IsEqualTo(FormModel? newOne)
        {
            if (newOne is null) return false;

            return CultureCode == newOne.CultureCode &&
                   EnglishName == newOne.EnglishName &&
                   NativeName == newOne.NativeName &&
                   GoToDetails == newOne.GoToDetails;
        }
    }

    protected bool IsSaving { get; set; }
    protected Exception? Exception { get; set; }

    protected async Task HandleValidSubmit()
    {
        if (Form is null || IsSaving || OnSave is null) return;

        IsSaving = true;
        Exception = null;

        StateHasChanged();

        try
        {
            await OnSave(Form);
        }
        catch (Exception ex)
        {
            Exception = ex;
        }
        finally
        {
            IsSaving = false;
        }
    }
}
